@model IEnumerable<Yoklama.Models.Entities.AttendanceRecord>
@{
    ViewData["Title"] = "Devamsız Öğrenciler";
    
    // Calculate statistics
    var totalAbsences = Model.Count();
    var todayAbsences = Model.Count(r => r.Session.ScheduledAt.Date == DateTime.Today);
    var thisWeekAbsences = Model.Count(r => r.Session.ScheduledAt >= DateTime.Today.AddDays(-(int)DateTime.Today.DayOfWeek));
    var uniqueStudents = Model.Select(r => r.StudentId).Distinct().Count();
}

<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4 flex-column flex-md-row gap-2 text-center text-md-start">
        <div>
            <h2 class="mb-1">
                <i class="fas fa-user-times text-danger me-2"></i>Devamsız Öğrenciler
            </h2>
            <p class="text-muted mb-0">Finalize edilmiş oturumlardaki devamsızlık kayıtları</p>
        </div>
        <div class="d-flex gap-2 flex-column flex-md-row no-print">
            <button type="button" class="btn btn-outline-primary text-center" onclick="window.print()">
                <i class="fas fa-print me-1"></i>Yazdır
            </button>
            <form asp-action="SendSms" method="post" class="d-inline w-100">
                @Html.AntiForgeryToken()
                <button type="submit" class="btn btn-primary text-center" onclick="return confirm('Tüm devamsız öğrencilere SMS gönderilsin mi?')">
                    <i class="fas fa-sms me-1"></i>SMS Gönder
                </button>
            </form>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4 g-3 no-print">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="d-flex align-items-center justify-content-center mb-2">
                        <div class="bg-danger bg-opacity-10 rounded-circle p-3">
                            <i class="fas fa-user-times text-danger fa-lg"></i>
                        </div>
                    </div>
                    <h4 class="mb-1 text-danger">@totalAbsences</h4>
                    <small class="text-muted">Toplam Devamsızlık</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="d-flex align-items-center justify-content-center mb-2">
                        <div class="bg-warning bg-opacity-10 rounded-circle p-3">
                            <i class="fas fa-calendar-day text-warning fa-lg"></i>
                        </div>
                    </div>
                    <h4 class="mb-1 text-warning">@todayAbsences</h4>
                    <small class="text-muted">Bugünkü Devamsızlık</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="d-flex align-items-center justify-content-center mb-2">
                        <div class="bg-info bg-opacity-10 rounded-circle p-3">
                            <i class="fas fa-calendar-week text-info fa-lg"></i>
                        </div>
                    </div>
                    <h4 class="mb-1 text-info">@thisWeekAbsences</h4>
                    <small class="text-muted">Bu Hafta Devamsızlık</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="d-flex align-items-center justify-content-center mb-2">
                        <div class="bg-secondary bg-opacity-10 rounded-circle p-3">
                            <i class="fas fa-users text-secondary fa-lg"></i>
                        </div>
                    </div>
                    <h4 class="mb-1 text-secondary">@uniqueStudents</h4>
                    <small class="text-muted">Farklı Öğrenci</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="card border-0 shadow-sm mb-4 no-print" id="filtersCard">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <h6 class="mb-0">
                <i class="fas fa-filter me-2"></i>Filtreler
            </h6>
            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="clearFilters()">
                <i class="fas fa-times me-1 d-none d-md-inline"></i>Temizle
            </button>
        </div>
        <div class="card-body">
            
            <form method="get" class="row g-3" id="filterForm">
                <div class="col-lg-2 col-md-6">
                    <label class="form-label">
                        <i class="fas fa-search me-1"></i>Arama
                    </label>
                    <input type="text" class="form-control" name="search" value="@ViewBag.Search" 
                           placeholder="Öğrenci, ders veya grup ara...">
                </div>
                <div class="col-lg-2 col-md-6">
                    <label class="form-label">
                        <i class="fas fa-layer-group me-1"></i>Grup
                    </label>
                    <select class="form-select" name="groupId">
                        <option value="">Tüm Gruplar</option>
                        @if (ViewBag.Groups != null)
                        {
                            @foreach (var group in ViewBag.Groups)
                            {
                                <option value="@group.Id" selected="@(ViewBag.GroupId?.ToString() == group.Id.ToString())">@group.Name</option>
                            }
                        }
                    </select>
                </div>
                <div class="col-lg-2 col-md-6">
                    <label class="form-label">
                        <i class="fas fa-calendar-day me-1"></i>Başlangıç
                    </label>
                    <input type="date" class="form-control" name="startDate" value="@ViewBag.StartDate">
                </div>
                <div class="col-lg-2 col-md-6">
                    <label class="form-label">
                        <i class="fas fa-calendar-day me-1"></i>Bitiş
                    </label>
                    <input type="date" class="form-control" name="endDate" value="@ViewBag.EndDate">
                </div>
                <div class="col-lg-2 col-md-6">
                    <label class="form-label">
                        <i class="fas fa-sort me-1"></i>Sırala
                    </label>
                    <select class="form-select" name="sortBy">
                        <option value="date" selected="@(ViewBag.SortBy == "date")">Tarih</option>
                        <option value="student" selected="@(ViewBag.SortBy == "student")">Öğrenci</option>
                        <option value="group" selected="@(ViewBag.SortBy == "group")">Grup</option>
                        <option value="lesson" selected="@(ViewBag.SortBy == "lesson")">Ders</option>
                    </select>
                </div>
                <div class="col-lg-2 col-md-6 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100 text-center" id="filterBtn">
                        <i class="fas fa-search me-1 d-none d-sm-inline"></i>
                        <span class="d-sm-none">Ara</span>
                        <span class="d-none d-sm-inline">Filtrele</span>
                    </button>
                </div>
            </form>
            
            <div id="warningAlert" class="alert alert-warning d-none mt-3" role="alert">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Zaten tüm kayıtlar gösteriliyor!</strong> Filtreleme yapmak için yukarıdaki alanları doldurun.
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="card border-0 shadow-sm">
        <div class="card-header bg-transparent">
            <h5 class="mb-0">
                <i class="fas fa-list me-2"></i>Devamsızlık Listesi
            </h5>
        </div>
        <div class="card-body">
            @if (Model.Any())
            {
                <div class="table-responsive">
                    <table class="table table-hover align-middle" id="absencesTable">
                        <thead class="table-dark">
                            <tr>
                                <th style="width: 150px;">
                                    <i class="fas fa-calendar me-1"></i>Tarih
                                </th>
                                <th>
                                    <i class="fas fa-user me-1"></i>Öğrenci
                                </th>
                                <th style="width: 120px;">
                                    <i class="fas fa-layer-group me-1"></i>Grup
                                </th>
                                <th>
                                    <i class="fas fa-book me-1"></i>Ders
                                </th>
                                <th style="width: 150px;">
                                    <i class="fas fa-info-circle me-1"></i>Durum
                                </th>
                                <th style="width: 120px;" class="text-end no-print">
                                    <i class="fas fa-cog me-1"></i>İşlemler
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                        @foreach (var r in Model)
                        {
                            <tr>
                                <td>
                                    <div class="d-flex flex-column">
                                        <span class="fw-bold">@r.Session.ScheduledAt.LocalDateTime.ToString("dd.MM.yyyy")</span>
                                        <small class="text-muted">@r.Session.ScheduledAt.LocalDateTime.ToString("HH:mm")</small>
                                    </div>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="bg-danger bg-opacity-10 rounded-circle p-2 me-3">
                                            <i class="fas fa-user text-danger"></i>
                                        </div>
                                        <div class="flex-grow-1">
                                            <strong class="text-truncate d-block" style="max-width: 150px;" title="@r.Student.FullName">@r.Student.FullName</strong>
                                            @if (!string.IsNullOrEmpty(r.Student.Phone))
                                            {
                                                <br><small class="text-muted"><i class="fas fa-phone me-1"></i>@r.Student.Phone</small>
                                            }
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge bg-primary bg-opacity-10 text-primary">@r.Session.Lesson.Group.Name</span>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-book text-muted me-2"></i>
                                        <span class="text-truncate" style="max-width: 200px;" title="@r.Session.Lesson.Title">@r.Session.Lesson.Title</span>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge bg-danger">
                                        <i class="fas fa-times me-1"></i>Yok
                                    </span>
                                </td>
                                <td class="text-end no-print">
                                    <a href="@Url.Action("Student", "Reports", new { studentId = r.StudentId })" 
                                       class="btn btn-outline-info btn-sm" 
                                       title="Öğrenci Raporu">
                                        <i class="fas fa-eye me-1"></i>Rapor
                                    </a>
                                </td>
                            </tr>
                        }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="text-center py-5">
                    <div class="mb-4">
                        <i class="fas fa-user-check fa-4x text-success opacity-50"></i>
                    </div>
                    <h5 class="text-muted mb-2">Tüm öğrenciler mevcut!</h5>
                    <p class="text-muted">Finalize edilmiş oturumlarda devamsızlık kaydı bulunmuyor.</p>
                </div>
            }
        </div>
    </div>
</div>

@section Styles {
    <style>
        @@media print {
            .d-print-none {
                display: none !important;
            }
            .card {
                border: 1px solid #dee2e6 !important;
                box-shadow: none !important;
            }
            .table {
                font-size: 12px;
            }
            .btn {
                display: none !important;
            }
        }
        
        /* Responsive improvements */
        @@media (max-width: 768px) {
            .card-header h6 {
                font-size: 0.9rem;
            }
            .form-label {
                font-size: 0.85rem;
                font-weight: 600;
            }
            .btn-sm {
                padding: 0.25rem 0.5rem;
                font-size: 0.75rem;
            }
        }
        
        @@media print {
            .no-print, .btn, .card-header, .dropdown, .sidebar, .content-header .d-flex > div:last-child {
                display: none !important;
            }
            
            .table {
                font-size: 12px;
            }
            
            .table th, .table td {
                padding: 0.5rem;
            }
            
            .container-fluid {
                padding: 0 !important;
            }
            
            .card {
                border: none !important;
                box-shadow: none !important;
            }
        }
        
        @@media (max-width: 576px) {
            .col-lg-3, .col-lg-2, .col-lg-1 {
                margin-bottom: 0.5rem;
            }
        .btn {
            width: 100% !important;
            white-space: nowrap;
            font-size: 0.875rem;
        }
        }
    </style>
}

@section Scripts {
    <script>
        function clearFilters() {
            // Clear all form inputs
            document.getElementById('filterForm').reset();
            
            // Redirect to clean URL
            window.location.href = '@Url.Action("Index", "Absences")';
        }
        
        // Auto-submit form on change for better UX
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('filterForm');
            const inputs = form.querySelectorAll('select, input[type="date"]');
            const filterBtn = document.getElementById('filterBtn');
            const warningAlert = document.getElementById('warningAlert');
            
            // Check if all filters are empty
            function areFiltersEmpty() {
                const search = form.querySelector('input[name="search"]').value.trim();
                const groupId = form.querySelector('select[name="groupId"]').value;
                const startDate = form.querySelector('input[name="startDate"]').value;
                const endDate = form.querySelector('input[name="endDate"]').value;
                
                return !search && !groupId && !startDate && !endDate;
            }
            
            // Check if we should disable button (from localStorage)
            function checkButtonState() {
                const hasShownAllRecords = localStorage.getItem('absencesAllRecordsShown') === 'true';
                if (hasShownAllRecords && areFiltersEmpty()) {
                    filterBtn.disabled = true;
                    filterBtn.innerHTML = '<i class="fas fa-ban me-1"></i>Devre Dışı';
                    warningAlert.classList.remove('d-none');
                }
            }
            
            // Initialize button state
            checkButtonState();
            
            // Handle form submit
            form.addEventListener('submit', function(e) {
                if (areFiltersEmpty()) {
                    const hasShownAllRecords = localStorage.getItem('absencesAllRecordsShown') === 'true';
                    if (hasShownAllRecords) {
                        e.preventDefault();
                        warningAlert.classList.remove('d-none');
                        return false;
                    } else {
                        // First time showing all records
                        localStorage.setItem('absencesAllRecordsShown', 'true');
                        filterBtn.disabled = true;
                        filterBtn.innerHTML = '<i class="fas fa-ban me-1"></i>Devre Dışı';
                        // Allow first submit to proceed
                    }
                } else {
                    // Has filters, reset state
                    localStorage.removeItem('absencesAllRecordsShown');
                    warningAlert.classList.add('d-none');
                    filterBtn.disabled = false;
                    filterBtn.innerHTML = '<i class="fas fa-search me-1 d-none d-sm-inline"></i><span class="d-sm-none">Ara</span><span class="d-none d-sm-inline">Filtrele</span>';
                }
            });
            
            // Enable button when any input changes
            function enableButton() {
                localStorage.removeItem('absencesAllRecordsShown');
                warningAlert.classList.add('d-none');
                filterBtn.disabled = false;
                filterBtn.innerHTML = '<i class="fas fa-search me-1 d-none d-sm-inline"></i><span class="d-sm-none">Ara</span><span class="d-none d-sm-inline">Filtrele</span>';
            }
            
            // Add event listeners to all inputs
            inputs.forEach(input => {
                input.addEventListener('change', function() {
                    enableButton();
                    // Don't auto-submit, let user click the filter button
                });
            });
            
            // Add event listener to search input for real-time updates
            const searchInput = form.querySelector('input[name="search"]');
            searchInput.addEventListener('input', function() {
                if (this.value.trim() !== '') {
                    enableButton();
                }
            });
        });
    </script>
}


