@model IEnumerable<Yoklama.Models.Entities.AttendanceRecord>
@{
    ViewData["Title"] = "Devamsız Öğrenciler";

    // Calculate statistics
    var totalAbsences = Model.Count();
    var todayAbsences = Model.Count(r => r.Session.ScheduledAt.Date == DateTime.Today);
    var thisWeekAbsences = Model.Count(r => r.Session.ScheduledAt >=
    DateTime.Today.AddDays(-(int)DateTime.Today.DayOfWeek));
    var uniqueStudents = Model.Select(r => r.StudentId).Distinct().Count();
}

<div class="container-fluid">
    <!-- Header -->
    <div
        class="d-flex justify-content-between align-items-center mb-4 flex-column flex-md-row gap-2 text-center text-md-start absences-header">
        <div>
            <h2 class="mb-1">
                <i class="fas fa-user-times text-danger me-2"></i>Devamsız Öğrenciler
            </h2>
            <p class="text-muted mb-0">Finalize edilmiş oturumlardaki devamsızlık kayıtları</p>
        </div>
        <div class="d-flex gap-2 flex-column flex-md-row no-print">
            <button type="button" class="btn btn-outline-primary text-center" onclick="window.print()">
                <i class="fas fa-print me-1"></i>Yazdır
            </button>
            <form asp-action="SendSms" method="post" class="d-inline w-100">
                @Html.AntiForgeryToken()
                <button type="submit" class="btn btn-primary text-center"
                    onclick="return confirm('Tüm devamsız öğrencilere SMS gönderilsin mi?')">
                    <i class="fas fa-sms me-1"></i>SMS Gönder
                </button>
            </form>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4 g-3 no-print">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="d-flex align-items-center justify-content-center mb-2">
                        <div class="bg-danger bg-opacity-10 rounded-circle p-3">
                            <i class="fas fa-user-times text-danger fa-lg"></i>
                        </div>
                    </div>
                    <h4 class="mb-1 text-danger">@totalAbsences</h4>
                    <small class="text-muted">Toplam Devamsızlık</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="d-flex align-items-center justify-content-center mb-2">
                        <div class="bg-warning bg-opacity-10 rounded-circle p-3">
                            <i class="fas fa-calendar-day text-warning fa-lg"></i>
                        </div>
                    </div>
                    <h4 class="mb-1 text-warning">@todayAbsences</h4>
                    <small class="text-muted">Bugünkü Devamsızlık</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="d-flex align-items-center justify-content-center mb-2">
                        <div class="bg-info bg-opacity-10 rounded-circle p-3">
                            <i class="fas fa-calendar-week text-info fa-lg"></i>
                        </div>
                    </div>
                    <h4 class="mb-1 text-info">@thisWeekAbsences</h4>
                    <small class="text-muted">Bu Hafta Devamsızlık</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="d-flex align-items-center justify-content-center mb-2">
                        <div class="bg-secondary bg-opacity-10 rounded-circle p-3">
                            <i class="fas fa-users text-secondary fa-lg"></i>
                        </div>
                    </div>
                    <h4 class="mb-1 text-secondary">@uniqueStudents</h4>
                    <small class="text-muted">Farklı Öğrenci</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="card border-0 shadow-sm mb-4 no-print" id="filtersCard">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <h6 class="mb-0">
                <i class="fas fa-filter me-2"></i>Filtreler
            </h6>
            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="clearFilters()">
                <i class="fas fa-times me-1 d-none d-md-inline"></i>Temizle
            </button>
        </div>
        <div class="card-body">

            <div class="row g-3" id="filterForm">
                <div class="col-lg-2 col-md-6">
                    <label class="form-label">
                        <i class="fas fa-search me-1"></i>Arama
                    </label>
                    <input type="text" class="form-control" id="searchInput"
                        placeholder="Öğrenci, ders veya grup ara...">
                </div>
                <div class="col-lg-2 col-md-6">
                    <label class="form-label">
                        <i class="fas fa-layer-group me-1"></i>Grup
                    </label>
                    <select class="form-select" id="groupFilter">
                        <option value="">Tüm Gruplar</option>
                        @if (ViewBag.Groups != null)
                        {
                            @foreach (var group in ViewBag.Groups)
                            {
                                <option value="@group.Name.ToLower()">@group.Name</option>
                            }
                        }
                    </select>
                </div>
                <div class="col-lg-2 col-md-6">
                    <label class="form-label">
                        <i class="fas fa-calendar-day me-1"></i>Başlangıç
                    </label>
                    <input type="date" class="form-control" id="startDateFilter">
                </div>
                <div class="col-lg-2 col-md-6">
                    <label class="form-label">
                        <i class="fas fa-calendar-day me-1"></i>Bitiş
                    </label>
                    <input type="date" class="form-control" id="endDateFilter">
                </div>
                <div class="col-lg-2 col-md-6">
                    <label class="form-label">
                        <i class="fas fa-sort me-1"></i>Sırala
                    </label>
                    <select class="form-select" id="sortByFilter">
                        <option value="date">Tarih</option>
                        <option value="student">Öğrenci</option>
                        <option value="group">Grup</option>
                        <option value="lesson">Ders</option>
                    </select>
                </div>
                <div class="col-lg-2 col-md-6 d-flex align-items-end">
                    <button type="button" class="btn btn-primary w-100 text-center" id="filterBtn">
                        <i class="fas fa-search me-1 d-none d-sm-inline"></i>
                        <span class="d-sm-none">Ara</span>
                        <span class="d-none d-sm-inline">Filtrele</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="card border-0 shadow-sm">
        <div class="card-header bg-transparent">
            <h5 class="mb-0">
                <i class="fas fa-list me-2"></i>Devamsızlık Listesi
            </h5>
        </div>
        <div class="card-body">
            @if (Model.Any())
            {
                <!-- Mobile List (< md) -->
                <div class="d-md-none mb-3">
                    <div class="list-group shadow-sm">
                        @foreach (AttendanceRecord r in Model)
                        {
                            if(!string.IsNullOrEmpty(r.Student.Phone))
                            {
                                <div class="list-group-item py-2"
                                     data-student="@r.Student.FullName.ToLower()"
                                     data-group="@r.Session.Lesson.Group.Name.ToLower()"
                                     data-lesson="@r.Session.Lesson.Title.ToLower()"
                                     data-date="@r.Session.ScheduledAt.ToString("yyyy-MM-dd")">
                                    <div class="d-flex justify-content-between align-items-start gap-2">
                                        <div class="flex-grow-1">
                                            <div class="fw-semibold text-truncate" title="@r.Student.FullName">@r.Student.FullName</div>
                                            <div class="text-muted small text-truncate" title="@r.Session.Lesson.Title">
                                                <i class="fas fa-book me-1"></i>@r.Session.Lesson.Title
                                            </div>
                                            <div class="d-flex align-items-center gap-2 mt-1">
                                                <span class="badge bg-primary bg-opacity-10 text-primary">@r.Session.Lesson.Group.Name</span>
                                                <span class="badge bg-danger"><i class="fas fa-times me-1"></i>Yok</span>
                                            </div>
                                            <div class="text-muted small mt-1">
                                                <i class="fas fa-phone me-1"></i>@r.Student.Phone
                                                <span class="ms-2">#@r.Student.StudentNumber</span>
                                            </div>
                                        </div>
                                        <div class="text-end ms-2">
                                            <div class="fw-semibold">@r.Session.ScheduledAt.LocalDateTime.ToString("dd.MM")</div>
                                            <small class="text-muted">@r.Session.ScheduledAt.LocalDateTime.ToString("HH:mm")</small>
                                            <div class="mt-2">
                                                <a href="@Url.Action(action: "Student", controller: "Reports", new { studentId = r.StudentId })" class="btn btn-sm btn-outline-secondary" title="Öğrenci Raporu">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                            else
                            {
                                <div class="list-group-item list-group-item-warning">
                                    <div class="small">
                                        <i class="fas fa-exclamation-circle me-2"></i>
                                        <span>Geçersiz telefon numarası nedeniyle </span>
                                        <a class="text-decoration-underline text-dark fw-semibold opacity-75" href="@Url.Action("Student","Reports", new {studentId = r.StudentId})">@r.Student.FullName</a>
                                        <span> için SMS gönderilemedi. Lütfen telefon numarasını kontrol edin.</span>
                                    </div>
                                </div>
                            }
                        }
                    </div>
                </div>

                <!-- Desktop Table (>= md) -->
                <div class="table-responsive d-none d-md-block">
                    <table class="table table-hover align-middle" id="absencesTable">
                        <thead class="table-dark">
                            <tr>
                                <th style="width: 150px;">
                                    <i class="fas fa-calendar me-1"></i>Tarih
                                </th>
                                <th>
                                    <i class="fas fa-user me-1"></i>Öğrenci
                                </th>
                                <th style="width: 120px;">
                                    <i class="fas fa-layer-group me-1"></i>Grup
                                </th>
                                <th>
                                    <i class="fas fa-book me-1"></i>Ders
                                </th>
                                <th style="width: 150px;">
                                    <i class="fas fa-info-circle me-1"></i>Durum
                                </th>
                                <th style="width: 120px;" class="text-end no-print">
                                    <i class="fas fa-cog me-1"></i>İşlemler
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (AttendanceRecord r in Model)
                            {
                                if(!string.IsNullOrEmpty(r.Student.Phone))
                                {
                                     <tr data-student="@r.Student.FullName.ToLower()"
                                         data-group="@r.Session.Lesson.Group.Name.ToLower()"
                                         data-lesson="@r.Session.Lesson.Title.ToLower()"
                                         data-date="@r.Session.ScheduledAt.ToString("yyyy-MM-dd")">
                                        <td>
                                            <div class="d-flex flex-column">
                                                <span
                                                    class="fw-bold">@r.Session.ScheduledAt.LocalDateTime.ToString(format: "dd.MM.yyyy")</span>
                                                <small
                                                    class="text-muted">@r.Session.ScheduledAt.LocalDateTime.ToString(format: "HH:mm")</small>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="bg-danger bg-opacity-10 rounded-circle p-2 me-3">
                                                    <i class="fas fa-user text-danger"></i>
                                                </div>
                                                <div class="flex-grow-1">
                                                    <strong class="text-truncate d-block" style="max-width: 150px;"
                                                        title="@r.Student.FullName">@r.Student.FullName</strong>
                                                    <span>@r.Student.StudentNumber</span>
                                                    <small class="text-muted"><i
                                                            class="fas fa-phone me-1"></i>@r.Student.Phone</small>

                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <span
                                                class="badge bg-primary bg-opacity-10 text-primary">@r.Session.Lesson.Group.Name</span>
                                        </td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-book text-muted me-2"></i>
                                                <span class="text-truncate" style="max-width: 200px;"
                                                    title="@r.Session.Lesson.Title">@r.Session.Lesson.Title</span>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="badge bg-danger">
                                                <i class="fas fa-times me-1"></i>Yok
                                            </span>
                                        </td>
                                        <td class="text-end no-print">
                                            <a href="@Url.Action(action: "Student", controller: "Reports", new { studentId = r.StudentId })"
                                                class="btn btn-outline-info btn-sm" title="Öğrenci Raporu">
                                                <i class="fas fa-eye me-1"></i>Rapor
                                            </a>
                                        </td>
                                    </tr>
                                }
                                else 
                                {
                                    <tr class="table-danger">
                                        <td colspan="6" class="text-center text-muted py-4">
                                            <i class="fas fa-exclamation-circle me-2"></i>
                                            <span>Geçersiz telefon numarası nedeniyle <a class="text-decoration-underline text-dark fw-semibold opacity-75" href="@Url.Action("Student","Reports", new {studentId = r.StudentId})">@r.Student.FullName</a> 
                                                için SMS gönderilemedi. Lütfen telefon numarasını kontrol edin.</span>
                                        </td>
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="text-center py-5">
                    <div class="mb-4">
                        <i class="fas fa-user-check fa-4x text-success opacity-50"></i>
                                
                    </div>
                    <h5 class="text-muted mb-2">Tüm öğrenciler mevcut!</h5>
                    <p class="text-muted">Finalize edilmiş oturumlarda devamsızlık kaydı bulunmuyor.</p>
                </div>
            }
        </div>
    </div>
</div>



@section Scripts {
    <script>
        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('groupFilter').value = '';
            document.getElementById('startDateFilter').value = '';
            document.getElementById('endDateFilter').value = '';
            document.getElementById('sortByFilter').value = 'date';
            applyFilters();
        }

        function applyFilters() {
            var search = document.getElementById('searchInput').value.toLowerCase().trim();
            var groupFilter = document.getElementById('groupFilter').value.toLowerCase().trim();
            var startDate = document.getElementById('startDateFilter').value;
            var endDate = document.getElementById('endDateFilter').value;
            var sortBy = document.getElementById('sortByFilter').value;

            // Desktop table rows
            var tableRows = document.querySelectorAll('#absencesTable tbody tr');
            // Mobile cards
            var mobileCards = document.querySelectorAll('.list-group-item[data-student]');

            var allItems = [...tableRows, ...mobileCards];

            allItems.forEach(function (item) {
                var student = (item.getAttribute('data-student') || '').toLowerCase();
                var group = (item.getAttribute('data-group') || '').toLowerCase();
                var lesson = (item.getAttribute('data-lesson') || '').toLowerCase();
                var date = item.getAttribute('data-date') || '';

                var matchSearch = !search || student.includes(search) || group.includes(search) || lesson.includes(search);
                var matchGroup = !groupFilter || group === groupFilter;
                var matchStartDate = !startDate || date >= startDate;
                var matchEndDate = !endDate || date <= endDate;

                if (matchSearch && matchGroup && matchStartDate && matchEndDate) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });

            // Sorting
            if (sortBy !== 'date') {
                var tbody = document.querySelector('#absencesTable tbody');
                if (tbody) {
                    var rows = Array.from(tbody.querySelectorAll('tr[data-student]'));
                    rows.sort(function (a, b) {
                        var aVal, bVal;
                        if (sortBy === 'student') {
                            aVal = a.getAttribute('data-student');
                            bVal = b.getAttribute('data-student');
                        } else if (sortBy === 'group') {
                            aVal = a.getAttribute('data-group');
                            bVal = b.getAttribute('data-group');
                        } else if (sortBy === 'lesson') {
                            aVal = a.getAttribute('data-lesson');
                            bVal = b.getAttribute('data-lesson');
                        }
                        return aVal.localeCompare(bVal);
                    });
                    rows.forEach(function (row) {
                        tbody.appendChild(row);
                    });
                }
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            var filterBtn = document.getElementById('filterBtn');
            var searchInput = document.getElementById('searchInput');

            if (filterBtn) filterBtn.addEventListener('click', applyFilters);
            if (searchInput) {
                searchInput.addEventListener('keypress', function (e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        applyFilters();
                    }
                });
            }

            // Auto-apply filters on change
            document.getElementById('groupFilter').addEventListener('change', applyFilters);
            document.getElementById('startDateFilter').addEventListener('change', applyFilters);
            document.getElementById('endDateFilter').addEventListener('change', applyFilters);
            document.getElementById('sortByFilter').addEventListener('change', applyFilters);
        });
    </script>
}