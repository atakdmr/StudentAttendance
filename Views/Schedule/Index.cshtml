@model Yoklama.Models.ViewModels.ScheduleVm
@using System.Security.Claims
@using System.Globalization

@{
    ViewData["Title"] = "Ders Programı";
    Guid.TryParse(User.FindFirst(ClaimTypes.NameIdentifier)?.Value, out Guid currentUserId);
    var todayName = DateTime.Today.ToString("dddd", new CultureInfo("tr-TR"));
}

<!-- Filtreleme Bölümü -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-lg-3 col-md-6">
                        <label for="dayOfWeek" class="form-label fw-semibold">
                            <i class="fas fa-calendar-day me-2 text-primary"></i>Gün Seçimi
                        </label>
                        <select id="dayOfWeek" class="form-select">
                            <option value="">Tüm Günler</option>
                            <option value="1">Pazartesi</option>
                            <option value="2">Salı</option>
                            <option value="3">Çarşamba</option>
                            <option value="4">Perşembe</option>
                            <option value="5">Cuma</option>
                            <option value="6">Cumartesi</option>
                            <option value="7">Pazar</option>
                        </select>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <label for="groupFilter" class="form-label fw-semibold">
                            <i class="fas fa-layer-group me-2 text-primary"></i>Grup Seçimi
                        </label>
                        <select id="groupFilter" class="form-select">
                            <option value="">Tüm Gruplar</option>
                            @foreach (var group in Model.Groups.Distinct())
                            {
                                <option value="@group.Name.ToLower()">@group.Name (@group.Code)</option>
                            }
                        </select>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <label for="lessonSearch" class="form-label fw-semibold">
                            <i class="fas fa-book me-2 text-primary"></i>Ders Ara
                        </label>
                        <div class="input-group">
                            <input type="text" id="lessonSearch" class="form-control" placeholder="Ders adı yazın...">
                            <button id="lessonSearchBtn" class="btn btn-primary" type="button">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 d-flex align-items-end">
                        <button id="clearFilters" class="btn btn-outline-secondary w-100">
                            <i class="fas fa-times me-1"></i>Filtreleri Temizle
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-calendar-alt me-2"></i>
                    Haftalık Ders Programım
                </h5>
            </div>
            <div class="card-body">
                <div class="schedule-grid">
                    @foreach (var day in Model.Days)
                    {
                        <div class="day-column" data-day="@day.DayOfWeek">
                            <div class="day-header">
                                <h6 class="day-title">@day.DayName</h6>
                            </div>
                            <div class="day-lessons">
                                @if (day.Lessons.Any())
                                {
                                    @foreach (var lesson in day.Lessons.OrderBy(l => l.StartTime))
                                    {
                                        <div class="lesson-card @(lesson.TeacherId == currentUserId ? "my-lesson" : "")"
                                             data-day="@day.DayOfWeek"
                                             data-group="@lesson.GroupName.ToLower()"
                                             data-title="@lesson.Title.ToLower()"
                                             data-teacher="@lesson.TeacherName.ToLower()">
                                                <div class="lesson-time">
                                                    @lesson.StartTime.ToString(@"hh\:mm") - @lesson.EndTime.ToString(@"hh\:mm")
                                                </div>
                                                <div class="lesson-title">
                                                    @lesson.Title
                                                </div>
                                                <div class="lesson-group">
                                                    <i class="fas fa-layer-group me-1"></i>
                                                    @lesson.GroupName
                                                </div>
                                                @if (Model.IsAdmin)
                                                {
                                                    <div class="lesson-teacher">
                                                        <i class="fas fa-user me-1"></i>
                                                        @lesson.TeacherName
                                                    </div>
                                                }
                                                @if (string.Equals(day.DayName, todayName, StringComparison.OrdinalIgnoreCase) && lesson.IsActive && lesson.TeacherId == currentUserId)
                                                {
                                                    @if (lesson.SessionStatus == null)
                                                    {
                                                        <div class="lesson-actions">
                                                            <a href="@Url.Action("OpenSession", "Lessons", new { lessonId = lesson.LessonId })"
                                                                class="btn btn-sm btn-primary">
                                                                <i class="fas fa-play me-1"></i>
                                                                Yoklama Başlat
                                                            </a>
                                                        </div>
                                                    }
                                                    else if (lesson.SessionStatus == Yoklama.Models.Entities.SessionStatus.Open)
                                                    {
                                                        <div class="lesson-actions">
                                                            <a href="@Url.Action("Session", "Attendance", new { sessionId = lesson.SessionId })"
                                                                class="btn btn-sm btn-warning">
                                                                <i class="fas fa-clipboard-check me-1"></i>
                                                                Devam Et
                                                            </a>
                                                        </div>
                                                    }
                                                    else if (lesson.SessionStatus == Yoklama.Models.Entities.SessionStatus.Closed)
                                                    {
                                                        <div class="lesson-actions">
                                                            <a href="@Url.Action("Session", "Attendance", new { sessionId = lesson.SessionId })"
                                                                class="btn btn-sm btn-success">
                                                                <i class="fas fa-clipboard-check me-1"></i>
                                                                Yoklama Al
                                                            </a>
                                                        </div>
                                                    }
                                                    else if (lesson.SessionStatus == Yoklama.Models.Entities.SessionStatus.Finalized)
                                                    {
                                                        <div class="lesson-actions">
                                                            <a href="@Url.Action("Session", "Attendance", new { sessionId = lesson.SessionId })"
                                                                class="btn btn-sm btn-info">
                                                                <i class="fas fa-eye me-1"></i>
                                                                Sonuçları Gör
                                                            </a>
                                                        </div>
                                                    }
                                                }
                                                else if (Model.IsAdmin)
                                                {
                                                    if (lesson.SessionStatus == Yoklama.Models.Entities.SessionStatus.Closed || lesson.SessionStatus == Yoklama.Models.Entities.SessionStatus.Finalized)
                                                    {
                                                        <div class="lesson-actions">
                                                            <a href="@Url.Action("Session", "Attendance", new { sessionId = lesson.SessionId })"
                                                               class="btn btn-sm btn-outline-secondary">
                                                                <i class="fas fa-eye me-1"></i>
                                                                Sonuçları Gör
                                                            </a>
                                                        </div>
                                                    }
                                                }

                                            </div>
                                    }
                                }
                                else
                                {
                                    <div class="no-lessons">
                                        <i class="fas fa-calendar-times"></i>
                                        <span>Ders yok</span>
                                    </div>
                                }
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>


<script>
    (function () {
        var dayFilter = document.getElementById('dayOfWeek');
        var groupFilter = document.getElementById('groupFilter');
        var lessonSearch = document.getElementById('lessonSearch');
        var searchBtn = document.getElementById('lessonSearchBtn');
        var clearBtn = document.getElementById('clearFilters');

        function applyFilters() {
            var selectedDay = (dayFilter.value || '').trim();
            var selectedGroup = (groupFilter.value || '').toLowerCase().trim();
            var searchQuery = (lessonSearch.value || '').toLowerCase().trim();

            // Tüm günleri kontrol et
            var dayColumns = document.querySelectorAll('.day-column');
            dayColumns.forEach(function (dayColumn) {
                var dayNumber = dayColumn.getAttribute('data-day');
                var shouldShowDay = !selectedDay || selectedDay === dayNumber;
                
                if (!shouldShowDay) {
                    dayColumn.style.display = 'none';
                    return;
                }

                // Gün içindeki dersleri filtrele
                var lessonCards = dayColumn.querySelectorAll('.lesson-card');
                var visibleLessons = 0;

                lessonCards.forEach(function (card) {
                    var cardGroup = (card.getAttribute('data-group') || '').toLowerCase();
                    var cardTitle = (card.getAttribute('data-title') || '').toLowerCase();
                    
                    var matchGroup = !selectedGroup || cardGroup === selectedGroup;
                    var matchSearch = !searchQuery || cardTitle.indexOf(searchQuery) !== -1;
                    
                    if (matchGroup && matchSearch) {
                        card.style.display = '';
                        visibleLessons++;
                    } else {
                        card.style.display = 'none';
                    }
                });

                // Gün görünür olacak mı?
                dayColumn.style.display = (visibleLessons > 0) ? '' : 'none';
            });
        }

        function clearFilters() {
            dayFilter.value = '';
            groupFilter.value = '';
            lessonSearch.value = '';
            applyFilters();
        }

        // Event listeners
        if (dayFilter) dayFilter.addEventListener('change', applyFilters);
        if (groupFilter) groupFilter.addEventListener('change', applyFilters);
        if (searchBtn) searchBtn.addEventListener('click', applyFilters);
        if (clearBtn) clearBtn.addEventListener('click', clearFilters);
        if (lessonSearch) {
            lessonSearch.addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    applyFilters();
                }
            });
        }
    })();
</script>