@model Yoklama.Models.ViewModels.ScheduleVm
@using System.Security.Claims

@{
    ViewData["Title"] = "Ders Programı";
    Guid.TryParse(User.FindFirst(ClaimTypes.NameIdentifier)?.Value, out Guid currentUserId);
}

<!-- Filtreleme Bölümü -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-body">
                <form method="get" class="row g-3">
                    <div class="col-lg-3 col-md-6">
                        <label for="dayOfWeek" class="form-label fw-semibold">
                            <i class="fas fa-calendar-day me-2 text-primary"></i>Gün Seçimi
                        </label>
                        <select name="dayOfWeek" id="dayOfWeek" class="form-select" onchange="autoFilter()">
                            <option value="">Tüm Günler</option>
                            <option value="1" selected="@(ViewBag.DayOfWeek?.ToString() == "1")">Pazartesi</option>
                            <option value="2" selected="@(ViewBag.DayOfWeek?.ToString() == "2")">Salı</option>
                            <option value="3" selected="@(ViewBag.DayOfWeek?.ToString() == "3")">Çarşamba</option>
                            <option value="4" selected="@(ViewBag.DayOfWeek?.ToString() == "4")">Perşembe</option>
                            <option value="5" selected="@(ViewBag.DayOfWeek?.ToString() == "5")">Cuma</option>
                            <option value="6" selected="@(ViewBag.DayOfWeek?.ToString() == "6")">Cumartesi</option>
                            <option value="7" selected="@(ViewBag.DayOfWeek?.ToString() == "7")">Pazar</option>
                        </select>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <label for="groupId" class="form-label fw-semibold">
                            <i class="fas fa-layer-group me-2 text-primary"></i>Grup Seçimi
                        </label>
                        <select name="groupId" id="groupId" class="form-select" onchange="autoFilter()">
                            <option value="">Tüm Gruplar</option>
                            @foreach (var group in Model.Groups)
                            {
                                <option value="@group.Id" selected="@(Model.SelectedGroupId?.ToString() == group.Id.ToString())">
                                    @group.Name (@group.Code)
                                </option>
                            }
                        </select>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <label for="lessonTitle" class="form-label fw-semibold">
                            <i class="fas fa-book me-2 text-primary"></i>Ders Seçimi
                        </label>
                        <div class="input-group">
                            <input type="text" name="lessonTitle" id="lessonTitle" class="form-control" 
                                   value="@ViewBag.SelectedLessonTitle" placeholder="Ders adı ara...">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="d-flex gap-2">
                            <a href="@Url.Action("Index")" class="btn btn-outline-secondary">
                                <i class="fas fa-times me-1"></i>Temizleme
                            </a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-calendar-alt me-2"></i>
                    Haftalık Ders Programım
                </h5>
            </div>
            <div class="card-body">
                @if ((Model.IsAdmin && !Model.HasAnyFilters) || (!Model.HasAnyFilters && !Model.Days.Any(d => d.Lessons.Any())))
                {
                    <div class="empty-state text-center py-5">
                        <div class="mb-4">
                            <i class="fas fa-filter fa-4x text-muted"></i>
                        </div>
                        <h4 class="text-muted mb-3">Filtreleme Gerekli</h4>
                        <p class="text-muted mb-4">
                            @if (Model.IsAdmin)
                            {
                                <text>Sistemdeki tüm dersleri görmek için yukarıdaki filtreleri kullanın.</text>
                            }
                            else
                            {
                                <text>Ders programınızı görmek için yukarıdaki filtreleri kullanın.</text>
                            }
                        </p>
                        @if (!Model.IsAdmin)
                        {
                            <div class="d-flex gap-2 justify-content-center">
                                <button type="button" class="btn btn-primary" onclick="showAllDays()">
                                    <i class="fas fa-calendar-week me-1"></i>Tüm Günleri Göster
                                </button>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="schedule-grid">
                        @foreach (var day in Model.Days)
                        {
                            <div class="day-column">
                                <div class="day-header">
                                    <h6 class="day-title">@day.DayName</h6>
                                </div>
                                <div class="day-lessons">
                                    @if (day.Lessons.Any())
                                    {
                                        @foreach (var lesson in day.Lessons.OrderBy(l => l.StartTime))
                                        {
                                            <div class="lesson-card @(lesson.TeacherId == currentUserId ? "my-lesson" : "")">
                                                <div class="lesson-time">
                                                    @lesson.StartTime.ToString(@"hh\:mm") - @lesson.EndTime.ToString(@"hh\:mm")
                                                </div>
                                                <div class="lesson-title">
                                                    @lesson.Title
                                                </div>
                                                <div class="lesson-group">
                                                    <i class="fas fa-layer-group me-1"></i>
                                                    @lesson.GroupName
                                                </div>
                                                <div class="lesson-teacher">
                                                    <i class="fas fa-user me-1"></i>
                                                    @lesson.TeacherName
                                                </div>
                                                @if (!Model.IsAdmin)
                                                {
                                                    <div class="lesson-actions">
                                                        <a href="@Url.Action("OpenSession", "Lessons", new { lessonId = lesson.LessonId })"
                                                           class="btn btn-sm btn-primary">
                                                            <i class="fas fa-play me-1"></i>
                                                            Yoklama Al
                                                        </a>
                                                    </div>
                                                }
                                            </div>
                                        }
                                    }
                                    else
                                    {
                                        <div class="no-lessons">
                                            <i class="fas fa-calendar-times"></i>
                                            <span>Ders yok</span>
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                }
            </div>
        </div>
    </div>
</div>


<script>
// Otomatik filtreleme fonksiyonu (sadece dropdown'lar için)
function autoFilter() {
    const form = document.querySelector('form');
    form.submit();
}

// Enter tuşu ile arama
document.getElementById('lessonTitle').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        const form = document.querySelector('form');
        form.submit();
    }
});

// Tüm günleri göster fonksiyonu
function showAllDays() {
    // Filtreleri temizle ve sayfayı yenile
    window.location.href = '@Url.Action("Index")';
}
</script>